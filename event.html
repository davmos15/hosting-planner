<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Hosting Planner</title>
    <link rel="icon" type="image/png" href="/Favicon.png">
    <link rel="shortcut icon" href="/Favicon.png">
    <link rel="apple-touch-icon" href="/Favicon.png">
    
    <!-- Firebase Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- User Profile Section (shown when logged in) -->
    <div class="user-profile-section" id="user-profile-section" style="display: none;">
        <div class="user-avatar" onclick="toggleEventUserMenu()" id="event-user-avatar">
            <span id="event-user-initial">U</span>
        </div>
        <div class="dropdown-menu" id="event-dropdown-menu" style="display: none;">
            <div class="user-info">
                <span id="event-user-email">user@example.com</span>
            </div>
            <button onclick="showUserDashboard()">📊 My Events</button>
            <button onclick="signOut()">🚪 Sign Out</button>
        </div>
    </div>
    
    <!-- New Event Button (shown when not logged in) -->
    <button class="new-event-btn" id="new-event-btn" onclick="createNewEvent()">✨ New Event +</button>
    
    <!-- Owner Controls -->
    <div class="owner-controls" id="owner-controls" style="display: none;">
        <div class="owner-badge" id="owner-badge">👑 Owner</div>
        <button class="settings-btn" onclick="showEventSettings()">⚙️ Settings</button>
    </div>

    <div class="container">
        <div class="header">
            <input type="text" class="event-name-input" id="event-name" placeholder="Enter event name..." value="Hosting Planner" onchange="updateEventName(this.value)">
            <div class="date" id="current-date" onclick="editDate()"></div>
            <input type="text" class="address-input" id="current-address" placeholder="📍 Enter event address..." onchange="updateAddress(this.value)">
        </div>
        
        <div class="host-info">
            <h2>The Host(s)</h2>
            <input type="text" class="host-input" id="current-host" placeholder="Enter host name(s)..." onchange="updateHost(this.value)">
        </div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection('guests-section')">
                <h3>👥 Guests<span class="collapse-indicator" id="guests-indicator">▼</span></h3>
            </div>
            <div class="section-content" id="guests-section">
                <div id="rsvp-list"></div>
            </div>
        </div>
        
        <div class="total-guests" id="guest-summary"></div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection('bring-section')">
                <h3>🍽️ What to Bring<span class="collapse-indicator" id="bring-indicator">▼</span></h3>
                <button class="edit-btn" onclick="editItems(); event.stopPropagation();">✏️ Edit Items</button>
            </div>
            <div class="section-content" id="bring-section">
                <div id="bring-list"></div>
            </div>
        </div>
        
        <button class="summary-btn" onclick="shareSummary()">
            📱 Share Event
        </button>
    </div>

    <!-- Selection Modal -->
    <div class="modal" id="selection-modal">
        <div class="modal-content">
            <h3 id="modal-title">Select Person</h3>
            <div id="person-list"></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Items Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <h3>Edit What to Bring</h3>
            <div id="edit-list"></div>
            <input type="text" id="new-item-input" placeholder="Add new item..." 
                   style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin: 10px 0;"
                   onkeypress="if(event.key==='Enter') addNewItem()">
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="addNewItem()">Add Item</button>
                <button class="modal-btn secondary" onclick="closeEditModal()">Done</button>
            </div>
        </div>
    </div>


    <!-- Edit Date Modal -->
    <div class="modal" id="date-modal">
        <div class="modal-content">
            <h3>Set Event Date</h3>
            <input type="date" id="date-input" 
                   style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin: 10px 0;">
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="saveDate()">Save Date</button>
                <button class="modal-btn secondary" onclick="closeDateModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Guests Modal -->
    <div class="modal" id="guests-modal">
        <div class="modal-content">
            <h3>Add Guests</h3>
            <input type="text" id="guest-name-input" placeholder="e.g., John, Sarah's Family - 5, Mike, The Smiths - 8" 
                   style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin: 10px 0;"
                   onkeypress="if(event.key==='Enter') addGuest()">
            <small style="display: block; color: #718096; margin-bottom: 15px;">Comma-separated list. Add " - number" for groups (defaults to 1)</small>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="addGuest()">Add Guests</button>
                <button class="modal-btn secondary" onclick="closeGuestsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="password-modal">
        <div class="modal-content">
            <h3>Password Required</h3>
            <p>This event is password protected.</p>
            <input type="password" id="password-input" placeholder="Enter password" onkeypress="if(event.key==='Enter') checkPassword()">
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="checkPassword()">Access Event</button>
            </div>
        </div>
    </div>

    <!-- Create Event Modal (same as landing page) -->
    <div class="modal" id="create-event-modal">
        <div class="modal-content large-modal">
            <h3>Create New Event</h3>
            
            <div class="form-section">
                <label for="event-name-input">Event Name *</label>
                <input type="text" id="event-name-input" placeholder="e.g., Birthday Party, Team Dinner" required>
            </div>
            
            <div class="form-row">
                <div class="form-section">
                    <label for="event-date-input">Date *</label>
                    <input type="date" id="event-date-input" required>
                </div>
                <div class="form-section">
                    <label for="event-host-input">Host(s)</label>
                    <input type="text" id="event-host-input" placeholder="Who's hosting?">
                </div>
            </div>
            
            <div class="form-section">
                <label for="event-address-input">Address</label>
                <input type="text" id="event-address-input" placeholder="Event location">
            </div>
            
            <div class="form-section">
                <label for="initial-guests-input">Initial Guests (optional)</label>
                <input type="text" id="initial-guests-input" placeholder="e.g., John, Sarah's Family - 5, Mike, The Smiths - 8">
                <small>Comma-separated list. Add " - number" for groups (defaults to 1)</small>
            </div>
            
            <div class="form-section">
                <label for="initial-items-input">Items Needed (optional)</label>
                <input type="text" id="initial-items-input" placeholder="e.g., Salad, Main dish, Dessert, Drinks">
                <small>Comma-separated list of items</small>
            </div>
            
            <div class="form-section">
                <label for="event-password-input">Password Protection (optional)</label>
                <div style="position: relative;">
                    <input type="password" id="event-password-input" placeholder="Leave blank for no password">
                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('event-password-input')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #718096; font-size: 16px;">👁️</button>
                </div>
                <small>If set, guests will need this password to access the event</small>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeCreateEventModal()">Cancel</button>
                <button class="modal-btn primary" onclick="createEventFromModal()">Create Event</button>
            </div>
        </div>
    </div>

    <!-- Event Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content large-modal">
            <h3>Event Settings</h3>
            
            <div class="settings-section">
                <h4>Guest List Permissions</h4>
                <label class="settings-toggle">
                    <input type="checkbox" id="allow-guest-view" checked>
                    <span>Allow guests to view guest list</span>
                </label>
                <label class="settings-toggle">
                    <input type="checkbox" id="allow-guest-edits" checked>
                    <span>Allow guests to edit their own name</span>
                </label>
            </div>
            
            <div class="settings-section">
                <h4>Items List Permissions</h4>
                <label class="settings-toggle">
                    <input type="checkbox" id="allow-item-view" checked>
                    <span>Allow guests to view items list</span>
                </label>
                <label class="settings-toggle">
                    <input type="checkbox" id="allow-item-edits" checked>
                    <span>Allow guests to add/edit items</span>
                </label>
            </div>
            
            
            <div class="settings-section">
                <h4>Password Management</h4>
                <div class="form-section">
                    <label for="settings-password">Event Password</label>
                    <div style="position: relative;">
                        <input type="password" id="settings-password" placeholder="Leave blank for no password">
                        <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('settings-password')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #718096; font-size: 16px;">👁️</button>
                    </div>
                    <small>Change or remove the event password</small>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="saveEventSettings()">Save Settings</button>
                <button class="modal-btn secondary" onclick="closeEventSettings()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- User Dashboard Modal -->
    <div class="modal" id="dashboard-modal">
        <div class="modal-content large-modal">
            <h3>My Events Dashboard</h3>
            <div class="dashboard-stats" id="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-events">0</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-events">0</div>
                    <div class="stat-label">Active Events</div>
                </div>
            </div>
            <div class="events-list" id="user-events-list">
                <p>Loading your events...</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="window.location.href='index.html';">Create New Event</button>
                <button class="modal-btn secondary" onclick="closeDashboardModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Guest Name Search Modal -->
    <div class="modal" id="guest-name-modal">
        <div class="modal-content">
            <h3>Find Your Name</h3>
            <p>Search for your name in the guest list:</p>
            <div class="form-section">
                <input type="text" id="guest-search-input" placeholder="Type your name..." style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" oninput="searchGuests()" onkeypress="if(event.key==='Enter') selectFirstMatch()">
            </div>
            <div id="guest-search-results" style="max-height: 200px; overflow-y: auto; margin: 10px 0;"></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="addNewGuest()">I'm not on the list</button>
            </div>
        </div>
    </div>

    <!-- Guest RSVP Modal -->
    <div class="modal" id="guest-rsvp-modal">
        <div class="modal-content">
            <h3 id="rsvp-guest-name">Your RSVP</h3>
            <p>Will you be attending this event?</p>
            <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0;">
                <button class="modal-btn primary" onclick="showGuestCountForRSVP()" style="background: #48bb78; min-width: 100px;">
                    ✓ Yes, I'll attend
                </button>
                <button class="modal-btn secondary" onclick="submitGuestRSVP('not-coming')" style="background: #f56565; color: white; min-width: 100px;">
                    ✗ Can't make it
                </button>
            </div>
            <div id="guest-count-section" style="display: none; text-align: center; margin-top: 15px;">
                <label for="guest-count-input">How many people total?</label>
                <input type="number" id="guest-count-input" value="1" min="1" max="20" style="width: 80px; padding: 8px; margin: 0 10px; text-align: center;">
                <br><br>
                <button class="modal-btn primary" onclick="submitGuestRSVP('coming')" style="background: #48bb78;">
                    Confirm RSVP
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - loaded from environment variables
        const firebaseConfig = {
            apiKey: "VITE_FIREBASE_API_KEY",
            authDomain: "VITE_FIREBASE_AUTH_DOMAIN",
            projectId: "VITE_FIREBASE_PROJECT_ID",
            storageBucket: "VITE_FIREBASE_STORAGE_BUCKET", 
            messagingSenderId: "VITE_FIREBASE_MESSAGING_SENDER_ID",
            appId: "VITE_FIREBASE_APP_ID",
            measurementId: "VITE_FIREBASE_MEASUREMENT_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Global auth and permission state
        let currentUser = null;
        let eventOwner = null;
        let eventPermissions = {
            allowGuestView: true,
            allowGuestEdits: true,
            allowItemView: true,
            allowItemEdits: true
        };
        
        // Guest list - starts empty, users will add guests
        let guestList = [];
        
        // Items needed for the event
        let bringItems = [];
        
        // State management
        let rsvpData = {};
        let bringData = {};
        let currentHost = '';
        let currentDate = '';
        let currentEventName = 'Hosting Planner';
        let currentAddress = '';
        let currentEventId = null;
        let currentEventPassword = null;
        let additionalGuests = [];
        let currentFilter = null; // 'attending', 'pending', 'not-attending', or null
        let currentGuestName = null; // Store the current guest's name
        
        // Initialize family member RSVPs (empty by default - will be populated from user input)
        // familyMembers will be replaced by user-added guests
        
        // Firebase Functions
        
        async function saveStateToFirebase() {
            try {
                const state = {
                    rsvpData,
                    bringData,
                    currentHost,
                    currentDate,
                    currentEventName,
                    currentAddress,
                    bringItems,
                    additionalGuests,
                    guestList,
                    password: currentEventPassword,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (currentEventId) {
                    await db.collection('events').doc(currentEventId).set(state);
                } else {
                    console.error('No event ID available for saving');
                }
                console.log('✅ State saved to Firebase');
            } catch (error) {
                console.error('❌ Failed to save to Firebase:', error);
            }
        }
        
        async function loadStateFromFirebase() {
            try {
                if (!currentEventId) {
                    console.error('No event ID provided');
                    return;
                }
                
                const doc = await db.collection('events').doc(currentEventId).get();
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Load ownership and permission data
                    eventOwner = data.ownerId || null;
                    if (data.permissions) {
                        eventPermissions = {
                            // New permission structure
                            allowGuestView: data.permissions.allowGuestView !== false, // default true for backward compatibility
                            allowGuestEdits: data.permissions.allowGuestEdits !== false,
                            allowItemView: data.permissions.allowItemView !== false,
                            allowItemEdits: data.permissions.allowItemEdits !== false,
                            // Handle old permission structure for backward compatibility
                            ...(data.permissions.hideGuestList !== undefined && {
                                allowGuestView: !data.permissions.hideGuestList
                            }),
                            ...(data.permissions.hideItemsList !== undefined && {
                                allowItemView: !data.permissions.hideItemsList
                            })
                        };
                    }
                    
                    // Load existing data from Firebase
                    if (data.rsvpData) rsvpData = data.rsvpData;
                    if (data.bringData) bringData = data.bringData;
                    if (data.currentHost) currentHost = data.currentHost;
                    if (data.currentDate) currentDate = data.currentDate;
                    if (data.currentEventName) currentEventName = data.currentEventName;
                    if (data.eventName) currentEventName = data.eventName; // Support both field names
                    if (data.currentAddress) currentAddress = data.currentAddress;
                    if (data.password) currentEventPassword = data.password;
                    if (data.bringItems) bringItems = data.bringItems;
                    if (data.additionalGuests) additionalGuests = data.additionalGuests;
                    if (data.guestList) guestList = data.guestList;
                    
                    // Ensure all guests have proper RSVP data
                    guestList.forEach(guest => {
                        if (!rsvpData[guest]) {
                            rsvpData[guest] = { status: 'pending', guests: 1, previousGuests: 1 };
                        } else {
                            if (rsvpData[guest].previousGuests === undefined) {
                                rsvpData[guest].previousGuests = rsvpData[guest].guests || 1;
                            }
                        }
                    });
                    
                    initializeBringData();
                    updateDisplay();
                    updateOwnershipUI();
                    updatePermissionBasedUI();
                    console.log('✅ State loaded from Firebase');
                } else {
                    // No existing data, create initial state
                    await saveStateToFirebase();
                }
            } catch (error) {
                console.error('❌ Failed to load from Firebase:', error);
            }
        }
        
        function setupRealtimeSync() {
            if (!currentEventId) return;
            
            db.collection('events').doc(currentEventId).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Update state with Firebase data
                    if (data.rsvpData) rsvpData = data.rsvpData;
                    if (data.bringData) bringData = data.bringData;
                    if (data.currentHost) currentHost = data.currentHost;
                    if (data.currentDate) currentDate = data.currentDate;
                    if (data.currentEventName) currentEventName = data.currentEventName;
                    if (data.eventName) currentEventName = data.eventName; // Support both field names
                    if (data.currentAddress) currentAddress = data.currentAddress;
                    if (data.password) currentEventPassword = data.password;
                    if (data.bringItems) bringItems = data.bringItems;
                    if (data.additionalGuests) additionalGuests = data.additionalGuests;
                    if (data.guestList) guestList = data.guestList;
                    
                    // Ensure all guests have proper RSVP data
                    guestList.forEach(guest => {
                        if (!rsvpData[guest]) {
                            rsvpData[guest] = { status: 'pending', guests: 1, previousGuests: 1 };
                        } else {
                            if (rsvpData[guest].previousGuests === undefined) {
                                rsvpData[guest].previousGuests = rsvpData[guest].guests || 1;
                            }
                        }
                    });
                    
                    initializeBringData();
                    updateDisplay();
                    console.log('🔄 Real-time update received');
                }
            }, (error) => {
                console.error('❌ Real-time sync error:', error);
            });
        }
        
        // Initialize bring items
        function initializeBringData() {
            bringItems.forEach(item => {
                if (!bringData[item]) {
                    bringData[item] = { assigned: false, person: null };
                }
            });
        }
        
        function getCurrentHost() {
            return currentHost || '';
        }
        
        function updateHost(value) {
            currentHost = value;
            saveStateToFirebase();
        }
        
        function updateEventName(value) {
            currentEventName = value;
            saveStateToFirebase();
        }
        
        function updateAddress(value) {
            currentAddress = value;
            saveStateToFirebase();
        }
        
        function getEventDate() {
            if (currentDate) {
                const dateObj = new Date(currentDate);
                return `📅 ${dateObj.toLocaleDateString('en-AU', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}`;
            }
            return '📅 No date set';
        }
        
        function updateDisplay() {
            // Update date and host
            document.getElementById('current-date').textContent = getEventDate();
            document.getElementById('current-host').value = getCurrentHost();
            document.getElementById('event-name').value = currentEventName;
            document.getElementById('current-address').value = currentAddress;
            
            // Update page title
            document.title = currentEventName || 'Hosting Planner';
            
            // Update RSVP list
            updateRSVPList();
            updateGuestSummary();
            updateBringList();
            
            // Initialize section heights for collapsible functionality
            setTimeout(initializeSectionHeights, 100);
        }
        
        function updateRSVPList() {
            const rsvpContainer = document.getElementById('rsvp-list');
            rsvpContainer.innerHTML = '';
            
            // Check if guest view is restricted
            const canViewAllGuests = eventPermissions.allowGuestView || isEventOwner();
            const isGuestUser = !isEventOwner() && currentGuestName;
            
            // If guest view is restricted, only show current guest's RSVP
            const guestsToShow = canViewAllGuests ? guestList : 
                (isGuestUser ? guestList.filter(guest => guest.toLowerCase() === currentGuestName.toLowerCase()) : []);
            
            // Display guest list
            guestsToShow.forEach(guest => {
                const memberData = rsvpData[guest] || { status: 'pending', guests: 1, previousGuests: 1 };
                const rsvpRow = document.createElement('div');
                rsvpRow.className = `rsvp-grid guest-row ${getFilterClass(memberData.status)}`;
                
                // Escape quotes in guest name for JavaScript
                const escapedGuest = guest.replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                // Different UI for owners vs guests
                if (isEventOwner()) {
                    // Owner sees single toggle button + guest count
                    rsvpRow.innerHTML = `
                        <div class="family-member" style="display: flex; align-items: center;">
                            <span onclick="editGuestName(${guestList.indexOf(guest)})" style="cursor: pointer; text-decoration: underline; text-decoration-style: dotted;">${guest}</span>
                            <button onclick="removeGuest(${guestList.indexOf(guest)})" style="margin-left: auto; background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 16px;">×</button>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="rsvp-btn ${memberData.status === 'coming' ? 'attending' : memberData.status === 'not-coming' ? 'not-attending' : 'pending'}" 
                                    onclick="toggleRSVP('${escapedGuest}')">
                                ${memberData.status === 'coming' ? 'Attending' : 
                                  memberData.status === 'not-coming' ? 'Can\'t Make It' : 'Pending'}
                            </button>
                            <input type="number" 
                                   class="guest-count" 
                                   value="${memberData.guests}" 
                                   min="1" 
                                   max="50"
                                   onchange="updateGuestCount('${escapedGuest}', this.value)"
                                   ${memberData.status !== 'coming' ? 'disabled' : ''}
                                   style="width: 60px;">
                        </div>
                    `;
                } else {
                    // Guest sees Yes/No buttons (if this is their name) or read-only status
                    const isCurrentGuest = currentGuestName && guest.toLowerCase() === currentGuestName.toLowerCase();
                    if (isCurrentGuest) {
                        rsvpRow.innerHTML = `
                            <div class="family-member" style="display: flex; align-items: center;">
                                <span>${guest}</span>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="rsvp-btn-new ${memberData.status === 'coming' ? 'active' : ''}" 
                                        onclick="setRSVPStatus('${escapedGuest}', 'coming')" 
                                        style="background: ${memberData.status === 'coming' ? '#48bb78' : '#f7fafc'}; color: ${memberData.status === 'coming' ? 'white' : '#4a5568'}; border: 1px solid ${memberData.status === 'coming' ? '#48bb78' : '#e2e8f0'}; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    ✓ Yes
                                </button>
                                <button class="rsvp-btn-new ${memberData.status === 'not-coming' ? 'active' : ''}" 
                                        onclick="setRSVPStatus('${escapedGuest}', 'not-coming')" 
                                        style="background: ${memberData.status === 'not-coming' ? '#f56565' : '#f7fafc'}; color: ${memberData.status === 'not-coming' ? 'white' : '#4a5568'}; border: 1px solid ${memberData.status === 'not-coming' ? '#f56565' : '#e2e8f0'}; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    ✗ No
                                </button>
                                <input type="number" 
                                       class="guest-count" 
                                       value="${memberData.guests}" 
                                       min="1" 
                                       max="50"
                                       onchange="updateGuestCount('${escapedGuest}', this.value)"
                                       ${memberData.status !== 'coming' ? 'disabled' : ''}
                                       style="width: 50px; margin-left: 8px;">
                            </div>
                        `;
                    } else {
                        // Other guests show read-only status
                        rsvpRow.innerHTML = `
                            <div class="family-member">${guest}</div>
                            <div style="padding: 6px 12px; background: ${memberData.status === 'coming' ? '#e6fffa' : memberData.status === 'not-coming' ? '#fed7d7' : '#f7fafc'}; border-radius: 6px; font-size: 12px;">
                                ${memberData.status === 'coming' ? '✓ Attending (' + memberData.guests + ')' : 
                                  memberData.status === 'not-coming' ? '✗ Can\'t make it' : '⏳ Pending'}
                            </div>
                        `;
                    }
                }
                
                rsvpContainer.appendChild(rsvpRow);
            });
            
            // Filter additional guests based on permissions
            const additionalGuestsToShow = canViewAllGuests ? additionalGuests : 
                (isGuestUser ? additionalGuests.filter(guest => guest.name.toLowerCase() === currentGuestName.toLowerCase()) : []);
            
            // Display additional guests
            additionalGuestsToShow.forEach((guest, displayIndex) => {
                // Find the actual index in the full additionalGuests array
                const actualIndex = additionalGuests.findIndex(g => g.name === guest.name);
                const index = actualIndex >= 0 ? actualIndex : displayIndex;
                const rsvpRow = document.createElement('div');
                rsvpRow.className = `rsvp-grid guest-row ${getFilterClass(guest.status)}`;
                
                // Different UI for owners vs guests for additional guests too
                if (isEventOwner()) {
                    // Owner sees single toggle button + guest count
                    rsvpRow.innerHTML = `
                        <div class="family-member" style="display: flex; align-items: center;">
                            ${guest.name}
                            <span style="color: #718096; font-size: 12px; margin-left: 5px;">(guest)</span>
                            <button onclick="removeAdditionalGuest(${index})" style="margin-left: auto; background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 16px;">×</button>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="rsvp-btn ${guest.status === 'coming' ? 'attending' : guest.status === 'not-coming' ? 'not-attending' : 'pending'}" 
                                    onclick="toggleAdditionalGuestStatus(${index})">
                                ${guest.status === 'coming' ? 'Attending' : 
                                  guest.status === 'not-coming' ? 'Can\'t Make It' : 'Pending'}
                            </button>
                            <input type="number" 
                                   class="guest-count" 
                                   value="${guest.guests || 1}" 
                                   min="1" 
                                   max="10"
                                   onchange="updateAdditionalGuestCount(${index}, this.value)"
                                   ${guest.status !== 'coming' ? 'disabled' : ''}
                                   style="width: 60px;">
                        </div>
                    `;
                } else {
                    // Guest view
                    const isCurrentGuest = currentGuestName && guest.name.toLowerCase() === currentGuestName.toLowerCase();
                    if (isCurrentGuest) {
                        rsvpRow.innerHTML = `
                            <div class="family-member" style="display: flex; align-items: center;">
                                ${guest.name}
                                <span style="color: #718096; font-size: 12px; margin-left: 5px;">(guest)</span>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="rsvp-btn-new ${guest.status === 'coming' ? 'active' : ''}" 
                                        onclick="setAdditionalGuestStatus(${index}, 'coming')" 
                                        style="background: ${guest.status === 'coming' ? '#48bb78' : '#f7fafc'}; color: ${guest.status === 'coming' ? 'white' : '#4a5568'}; border: 1px solid ${guest.status === 'coming' ? '#48bb78' : '#e2e8f0'}; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    ✓ Yes
                                </button>
                                <button class="rsvp-btn-new ${guest.status === 'not-coming' ? 'active' : ''}" 
                                        onclick="setAdditionalGuestStatus(${index}, 'not-coming')" 
                                        style="background: ${guest.status === 'not-coming' ? '#f56565' : '#f7fafc'}; color: ${guest.status === 'not-coming' ? 'white' : '#4a5568'}; border: 1px solid ${guest.status === 'not-coming' ? '#f56565' : '#e2e8f0'}; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    ✗ No
                                </button>
                                <input type="number" 
                                       class="guest-count" 
                                       value="${guest.guests || 1}" 
                                       min="1" 
                                       max="10"
                                       onchange="updateAdditionalGuestCount(${index}, this.value)"
                                       ${guest.status !== 'coming' ? 'disabled' : ''}
                                       style="width: 50px; margin-left: 8px;">
                            </div>
                        `;
                    } else {
                        // Other guests show read-only status
                        rsvpRow.innerHTML = `
                            <div class="family-member">${guest.name} <span style="color: #718096; font-size: 12px;">(guest)</span></div>
                            <div style="padding: 6px 12px; background: ${guest.status === 'coming' ? '#e6fffa' : guest.status === 'not-coming' ? '#fed7d7' : '#f7fafc'}; border-radius: 6px; font-size: 12px;">
                                ${guest.status === 'coming' ? '✓ Attending (' + (guest.guests || 1) + ')' : 
                                  guest.status === 'not-coming' ? '✗ Can\'t make it' : '⏳ Pending'}
                            </div>
                        `;
                    }
                }
                
                rsvpContainer.appendChild(rsvpRow);
            });
            
            // Show Add Guests button for owners, or guests with edit permissions  
            const canEditGuests = isEventOwner() || (eventPermissions.allowGuestEdits && currentGuestName);
            
            if (guestsToShow.length === 0 && additionalGuestsToShow.length === 0) {
                if (canViewAllGuests || isEventOwner()) {
                    rsvpContainer.innerHTML = `
                        <div style="padding: 30px 20px; text-align: center;">
                            <p style="color: #718096; margin-bottom: 15px;">No guests added yet</p>
                            ${canEditGuests ? '<button class="edit-btn" onclick="showAddGuestsModal()" style="padding: 10px 20px;">➕ Add Guests</button>' : ''}
                        </div>
                    `;
                } else {
                    rsvpContainer.innerHTML = `
                        <div style="padding: 30px 20px; text-align: center;">
                            <p style="color: #718096; margin-bottom: 15px;">You haven't RSVP'd yet</p>
                            <p style="color: #718096; font-size: 14px;">Your name will appear here after you RSVP</p>
                        </div>
                    `;
                }
            } else if (canEditGuests) {
                // Add "Add Guests" button at the bottom for owners or users with edit permissions
                const addGuestsBtn = document.createElement('div');
                addGuestsBtn.style.cssText = 'padding: 15px 20px; text-align: center;';
                addGuestsBtn.innerHTML = `
                    <button class="edit-btn" onclick="showAddGuestsModal()" style="width: 100%;">
                        ➕ Add Guests
                    </button>
                `;
                rsvpContainer.appendChild(addGuestsBtn);
            }
        }
        
        function toggleRSVP(member) {
            if (!rsvpData[member]) {
                rsvpData[member] = { status: 'pending', guests: 1, previousGuests: 1 };
            }
            
            const current = rsvpData[member].status;
            
            if (current === 'pending') {
                rsvpData[member].status = 'coming';
                // Restore previous guest count when switching to coming
                rsvpData[member].guests = rsvpData[member].previousGuests || 1;
            } else if (current === 'coming') {
                // Store current guest count before switching away from coming
                rsvpData[member].previousGuests = rsvpData[member].guests;
                rsvpData[member].status = 'not-coming';
                rsvpData[member].guests = 0;
            } else if (current === 'not-coming') {
                rsvpData[member].status = 'pending';
                rsvpData[member].guests = 0;
            }
            
            updateDisplay();
            saveStateToFirebase();
        }
        
        function toggleAdditionalGuestStatus(index) {
            if (additionalGuests[index]) {
                const current = additionalGuests[index].status;
                
                if (current === 'pending') {
                    additionalGuests[index].status = 'coming';
                    // Restore previous guest count when switching to coming
                    additionalGuests[index].guests = additionalGuests[index].previousGuests || 1;
                } else if (current === 'coming') {
                    // Store current guest count before switching away from coming
                    additionalGuests[index].previousGuests = additionalGuests[index].guests || 1;
                    additionalGuests[index].status = 'not-coming';
                    additionalGuests[index].guests = 0;
                } else if (current === 'not-coming') {
                    additionalGuests[index].status = 'pending';
                    additionalGuests[index].guests = 0;
                }
                
                updateDisplay();
                saveStateToFirebase();
            }
        }
        
        function setRSVPStatus(member, status) {
            if (!rsvpData[member]) {
                rsvpData[member] = { status: 'pending', guests: 1, previousGuests: 1 };
            }
            
            if (status === 'coming') {
                // Store current guest count before switching away from coming
                if (rsvpData[member].status === 'coming') {
                    rsvpData[member].previousGuests = rsvpData[member].guests;
                }
                rsvpData[member].status = 'coming';
                // Restore previous guest count when switching to coming
                rsvpData[member].guests = rsvpData[member].previousGuests || 1;
            } else if (status === 'not-coming') {
                // Store current guest count before switching away from coming
                if (rsvpData[member].status === 'coming') {
                    rsvpData[member].previousGuests = rsvpData[member].guests;
                }
                rsvpData[member].status = 'not-coming';
                rsvpData[member].guests = 0;
            }
            
            updateDisplay();
            saveStateToFirebase();
        }
        
        function setAdditionalGuestStatus(index, status) {
            if (additionalGuests[index]) {
                if (status === 'coming') {
                    // Store current guest count before switching away from coming
                    if (additionalGuests[index].status === 'coming') {
                        additionalGuests[index].previousGuests = additionalGuests[index].guests || 1;
                    }
                    additionalGuests[index].status = 'coming';
                    // Restore previous guest count when switching to coming
                    additionalGuests[index].guests = additionalGuests[index].previousGuests || 1;
                } else if (status === 'not-coming') {
                    // Store current guest count before switching away from coming
                    if (additionalGuests[index].status === 'coming') {
                        additionalGuests[index].previousGuests = additionalGuests[index].guests || 1;
                    }
                    additionalGuests[index].status = 'not-coming';
                    additionalGuests[index].guests = 0;
                }
                
                updateDisplay();
                saveStateToFirebase();
            }
        }
        
        function updateGuestCount(member, count) {
            const newCount = parseInt(count) || 1;
            rsvpData[member].guests = newCount;
            // Store as previous count for when they switch status
            if (rsvpData[member].status === 'coming') {
                rsvpData[member].previousGuests = newCount;
            }
            updateGuestSummary();
            saveStateToFirebase();
        }
        
        function updateGuestSummary() {
            const canViewAllGuests = eventPermissions.allowGuestView || isEventOwner();
            
            if (!canViewAllGuests && currentGuestName) {
                // For restricted guests, only show simple "attending" count
                const mainGuests = guestList
                    .filter(guest => rsvpData[guest] && rsvpData[guest].status === 'coming')
                    .reduce((sum, guest) => sum + (rsvpData[guest].guests || 0), 0);
                
                const additionalAttendingPeople = additionalGuests
                    .filter(g => g.status === 'coming')
                    .reduce((sum, g) => sum + (g.guests || 1), 0);
                
                const totalAttending = mainGuests + additionalAttendingPeople;
                
                document.getElementById('guest-summary').innerHTML = `
                    <div style="text-align: center; padding: 15px; background: #e6fffa; border-radius: 8px; border: 1px solid #81e6d9;">
                        <div style="font-size: 24px; font-weight: bold; color: #234e52; margin-bottom: 5px;">${totalAttending}</div>
                        <div style="color: #234e52; font-size: 14px;">guests attending</div>
                    </div>
                `;
                return;
            }
            
            // Full summary for event owners and when guest view is allowed
            const mainGuests = guestList
                .filter(guest => rsvpData[guest] && rsvpData[guest].status === 'coming')
                .reduce((sum, guest) => sum + (rsvpData[guest].guests || 0), 0);
            
            const additionalGuestsTotal = additionalGuests
                .filter(g => g.status === 'coming')
                .reduce((sum, guest) => sum + (guest.guests || 1), 0);
            
            const totalGuests = mainGuests + additionalGuestsTotal;
            
            // Count total people, not just entries
            const attendingPeople = guestList
                .filter(guest => rsvpData[guest] && rsvpData[guest].status === 'coming')
                .reduce((sum, guest) => sum + (rsvpData[guest].guests || 0), 0);
            
            const notAttendingPeople = guestList
                .filter(guest => rsvpData[guest] && rsvpData[guest].status === 'not-coming')
                .reduce((sum, guest) => sum + (rsvpData[guest].previousGuests || 1), 0);
            
            const pendingPeople = guestList
                .filter(guest => !rsvpData[guest] || rsvpData[guest].status === 'pending')
                .reduce((sum, guest) => sum + ((rsvpData[guest] && rsvpData[guest].previousGuests) || 1), 0);
            
            const additionalAttendingPeople = additionalGuests
                .filter(g => g.status === 'coming')
                .reduce((sum, g) => sum + (g.guests || 1), 0);
            const additionalNotAttendingPeople = additionalGuests
                .filter(g => g.status === 'not-coming')
                .reduce((sum, g) => sum + (g.previousGuests || 1), 0);
            
            // Calculate total invited guests regardless of status
            const totalInvitedGuests = guestList.reduce((sum, guest) => {
                const guestData = rsvpData[guest] || { previousGuests: 1 };
                return sum + (guestData.previousGuests || 1);
            }, 0) + additionalGuests.reduce((sum, guest) => sum + (guest.previousGuests || 1), 0);
            
            document.getElementById('guest-summary').innerHTML = `
                <div class="status-counts">
                    <div class="status-count ${currentFilter === 'attending' ? 'active' : ''}" onclick="filterGuests('attending')">
                        <div class="count">${attendingPeople + additionalAttendingPeople}</div>
                        <div class="label">Attending</div>
                    </div>
                    <div class="status-count ${currentFilter === 'pending' ? 'active' : ''}" onclick="filterGuests('pending')">
                        <div class="count">${pendingPeople}</div>
                        <div class="label">Pending</div>
                    </div>
                    <div class="status-count ${currentFilter === 'not-attending' ? 'active' : ''}" onclick="filterGuests('not-attending')">
                        <div class="count">${notAttendingPeople + additionalNotAttendingPeople}</div>
                        <div class="label">Can't Make It</div>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 16px;">
                    <strong>${totalInvitedGuests} total guests invited</strong>
                </div>
            `;
        }
        
        function updateBringList() {
            const bringContainer = document.getElementById('bring-list');
            bringContainer.innerHTML = '';
            
            if (bringItems.length === 0) {
                // Show "Add Items" button when list is empty
                bringContainer.innerHTML = `
                    <div style="padding: 30px 20px; text-align: center;">
                        <p style="color: #718096; margin-bottom: 15px;">No items added yet</p>
                        <button class="edit-btn" onclick="editItems()" style="padding: 10px 20px;">
                            ➕ Add Items
                        </button>
                    </div>
                `;
            } else {
                bringItems.forEach((item, index) => {
                    const itemData = bringData[item];
                    const itemRow = document.createElement('div');
                    itemRow.className = 'bring-item';
                    itemRow.draggable = true;
                    itemRow.dataset.index = index;
                    
                    // Escape quotes in item name
                    const escapedItem = item.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    
                    itemRow.innerHTML = `
                        <div style="display: flex; align-items: center; flex: 1;">
                            <span class="drag-handle">☰</span>
                            <div class="item-name" onclick="editItemName('${escapedItem}')" style="cursor: pointer; text-decoration: underline; text-decoration-style: dotted;">${item}</div>
                        </div>
                        <div class="item-status ${itemData.assigned ? 'item-covered' : 'item-needed'}"
                             onclick="claimItem('${escapedItem}')">
                            ${itemData.assigned ? `✓ ${itemData.person} (tap to change)` : 'Tap to claim'}
                        </div>
                    `;
                    
                    // Add drag event listeners
                    itemRow.addEventListener('dragstart', handleDragStart);
                    itemRow.addEventListener('dragover', handleDragOver);
                    itemRow.addEventListener('drop', handleDrop);
                    itemRow.addEventListener('dragend', handleDragEnd);
                    
                    bringContainer.appendChild(itemRow);
                });
            }
        }
        
        function claimItem(item) {
            // Show selection modal
            document.getElementById('modal-title').textContent = `Who will bring ${item}?`;
            const personList = document.getElementById('person-list');
            personList.innerHTML = '';
            
            // Show all guests who are attending
            const attendingGuests = [...guestList.filter(g => rsvpData[g] && rsvpData[g].status === 'coming'),
                                   ...additionalGuests.filter(g => g.status === 'coming').map(g => g.name)];
            
            if (attendingGuests.length === 0) {
                personList.innerHTML = '<p style="text-align: center; color: #718096;">No confirmed guests yet</p>';
            } else {
                attendingGuests.forEach(person => {
                    const btn = document.createElement('button');
                    btn.className = 'person-btn';
                    btn.textContent = person;
                    btn.onclick = () => {
                        bringData[item] = { assigned: true, person: person };
                        updateBringList();
                        closeModal();
                        saveStateToFirebase();
                    };
                    personList.appendChild(btn);
                });
            }
            
            document.getElementById('selection-modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('selection-modal').style.display = 'none';
        }
        
        function editItems() {
            if (!canEditItems()) {
                alert('You do not have permission to edit items for this event.');
                return;
            }
            updateEditList();
            document.getElementById('edit-modal').style.display = 'flex';
        }
        
        function updateEditList() {
            const editList = document.getElementById('edit-list');
            editList.innerHTML = '';
            
            bringItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'edit-item';
                // Escape quotes in item name
                const escapedItem = item.replace(/'/g, "\\'").replace(/"/g, '\\"');
                itemDiv.innerHTML = `
                    <span>${item}</span>
                    <button class="remove-btn" onclick="removeItem('${escapedItem}')">Remove</button>
                `;
                editList.appendChild(itemDiv);
            });
        }
        
        function removeItem(item) {
            if (confirm(`Remove "${item}" from the list?`)) {
                bringItems = bringItems.filter(i => i !== item);
                delete bringData[item];
                updateEditList();
                updateBringList();
                saveStateToFirebase();
            }
        }
        
        function addNewItem() {
            const input = document.getElementById('new-item-input');
            const newItem = input.value.trim();
            if (newItem && !bringItems.includes(newItem)) {
                bringItems.push(newItem);
                bringData[newItem] = { assigned: false, person: null };
                input.value = '';
                updateEditList();
                updateBringList();
                saveStateToFirebase();
            }
        }
        
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }
        
        // Host editing is now handled by the text input directly
        
        function editDate() {
            // Pre-fill with current date or next Saturday
            const dateInput = document.getElementById('date-input');
            if (currentDate) {
                dateInput.value = currentDate;
            } else {
                // Set to today's date as default
                const today = new Date();
                dateInput.value = today.toISOString().split('T')[0];
            }
            
            document.getElementById('date-modal').style.display = 'flex';
        }
        
        function saveDate() {
            const dateInput = document.getElementById('date-input');
            if (dateInput.value) {
                currentDate = dateInput.value;
                updateDisplay();
                saveStateToFirebase();
            }
            closeDateModal();
        }
        
        function closeDateModal() {
            document.getElementById('date-modal').style.display = 'none';
        }
        
        function showAddGuestsModal() {
            if (!canEditGuests()) {
                alert('You do not have permission to add guests to this event.');
                return;
            }
            document.getElementById('guest-name-input').value = '';
            document.getElementById('guest-name-input').focus();
            document.getElementById('guests-modal').style.display = 'flex';
        }
        
        function closeGuestsModal() {
            document.getElementById('guests-modal').style.display = 'none';
        }
        
        function addGuest() {
            const input = document.getElementById('guest-name-input');
            const guestsText = input.value.trim();
            
            if (!guestsText) return;
            
            // Parse the comma-separated list of guests
            const guestEntries = guestsText.split(',').map(entry => entry.trim()).filter(entry => entry);
            
            guestEntries.forEach(entry => {
                const match = entry.match(/^(.+?)\s*-\s*(\d+)$/);
                let guestName, guestCount;
                
                if (match) {
                    guestName = match[1].trim();
                    guestCount = parseInt(match[2]);
                } else {
                    guestName = entry.trim();
                    guestCount = 1;
                }
                
                // Check if guest already exists
                if (!guestList.includes(guestName)) {
                    // Add to main guest list
                    guestList.push(guestName);
                    rsvpData[guestName] = { status: 'pending', guests: guestCount, previousGuests: guestCount };
                }
            });
            
            input.value = '';
            closeGuestsModal();
            updateRSVPList();
            updateGuestSummary();
            saveStateToFirebase();
        }
        
        
        
        function removeAdditionalGuest(index) {
            if (confirm('Remove this guest?')) {
                additionalGuests.splice(index, 1);
                updateRSVPList();
                updateGuestSummary();
                saveStateToFirebase();
            }
        }
        
        function updateAdditionalGuestCount(index, count) {
            const newCount = parseInt(count) || 1;
            additionalGuests[index].guests = newCount;
            // Store as previous count for when they switch status
            if (additionalGuests[index].status === 'coming') {
                additionalGuests[index].previousGuests = newCount;
            }
            updateGuestSummary();
            saveStateToFirebase();
        }
        
        function editItemName(oldName) {
            const newName = prompt(`Edit item name:`, oldName);
            if (newName && newName.trim() && newName !== oldName) {
                const trimmedName = newName.trim();
                
                // Check if new name already exists
                if (bringItems.includes(trimmedName)) {
                    alert('An item with this name already exists!');
                    return;
                }
                
                // Update the item name in bringItems array
                const index = bringItems.indexOf(oldName);
                if (index > -1) {
                    bringItems[index] = trimmedName;
                }
                
                // Move the data from old key to new key
                bringData[trimmedName] = bringData[oldName];
                delete bringData[oldName];
                
                // Update the display and save
                updateBringList();
                saveStateToFirebase();
            }
        }
        
        function editGuestName(index) {
            const oldName = guestList[index];
            const newName = prompt(`Edit guest name:`, oldName);
            if (newName && newName.trim() && newName !== oldName) {
                const trimmedName = newName.trim();
                
                // Check if new name already exists
                if (guestList.includes(trimmedName)) {
                    alert('A guest with this name already exists!');
                    return;
                }
                
                // Update the guest name in guestList array
                guestList[index] = trimmedName;
                
                // Move the RSVP data from old key to new key
                rsvpData[trimmedName] = rsvpData[oldName];
                delete rsvpData[oldName];
                
                // Update any bring items assigned to this person
                Object.keys(bringData).forEach(item => {
                    if (bringData[item].person === oldName) {
                        bringData[item].person = trimmedName;
                    }
                });
                
                // Update the display and save
                updateDisplay();
                saveStateToFirebase();
            }
        }
        
        function removeGuest(index) {
            const guestName = guestList[index];
            if (confirm(`Remove ${guestName} from the guest list?`)) {
                // Remove from guest list
                guestList.splice(index, 1);
                
                // Remove RSVP data
                delete rsvpData[guestName];
                
                // Unassign any items they were bringing
                Object.keys(bringData).forEach(item => {
                    if (bringData[item].person === guestName) {
                        bringData[item] = { assigned: false, person: null };
                    }
                });
                
                // Update the display and save
                updateDisplay();
                saveStateToFirebase();
            }
        }
        
        function getFilterClass(status) {
            if (currentFilter === null) return '';
            
            const statusMap = {
                'coming': 'attending',
                'not-coming': 'not-attending',
                'pending': 'pending'
            };
            
            return currentFilter === statusMap[status] ? '' : 'hidden';
        }
        
        function filterGuests(filterType) {
            if (currentFilter === filterType) {
                // Already filtered by this type, remove filter
                currentFilter = null;
            } else {
                // Apply new filter
                currentFilter = filterType;
            }
            
            // Update the display to show/hide guests
            updateRSVPList();
            updateGuestSummary();
        }
        
        // Drag and drop variables
        let draggedItemIndex = null;
        
        function handleDragStart(e) {
            draggedItemIndex = parseInt(e.target.dataset.index);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const dropIndex = parseInt(e.target.closest('.bring-item').dataset.index);
            
            if (draggedItemIndex !== null && draggedItemIndex !== dropIndex) {
                // Reorder the items array
                const draggedItem = bringItems[draggedItemIndex];
                bringItems.splice(draggedItemIndex, 1);
                bringItems.splice(dropIndex, 0, draggedItem);
                
                // Update display and save
                updateBringList();
                saveStateToFirebase();
            }
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedItemIndex = null;
        }
        
        async function shareSummary() {
            const host = getCurrentHost() || 'TBD';
            
            // Format date properly
            let formattedDate = 'TBD';
            if (currentDate) {
                const dateObj = new Date(currentDate);
                formattedDate = dateObj.toLocaleDateString('en-GB', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
            
            // Get the proper base URL with custom event URL
            const baseURL = `https://hosting-planner.vercel.app/event.html?id=${currentEventId}`;
            
            let message = `📅 *${currentEventName || 'Event'}*\n`;
            message += `📅 *Date:* 📅 ${formattedDate}\n`;
            message += `🏠 *Host(s):* ${host}\n`;
            if (currentAddress) {
                message += `📌 *${currentAddress}*\n`;
            }
            message += `\n🔗 RSVP & confirm what you can bring: ${baseURL}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(message).then(() => {
                alert('📱 Event details copied to clipboard!\nShare via your preferred messaging app.');
            }).catch(() => {
                alert('Event details ready:\n\n' + message);
            });
        }
        
        // Get event ID from URL
        function getEventIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // Check if password is required and correct
        async function checkEventAccess() {
            if (!currentEventId) {
                alert('Invalid event URL');
                window.location.href = 'index.html';
                return false;
            }
            
            try {
                const doc = await db.collection('events').doc(currentEventId).get();
                
                if (!doc.exists) {
                    alert('Event not found');
                    window.location.href = 'index.html';
                    return false;
                }
                
                const eventData = doc.data();
                currentEventPassword = eventData.password;
                
                if (currentEventPassword) {
                    // Check if password was provided or stored
                    const storedPassword = sessionStorage.getItem(`eventPassword_${currentEventId}`);
                    if (storedPassword !== currentEventPassword) {
                        showPasswordModal();
                        return false;
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error checking event access:', error);
                alert('Failed to load event');
                window.location.href = 'index.html';
                return false;
            }
        }
        
        function showPasswordModal() {
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('password-input').focus();
        }
        
        function checkPassword() {
            const enteredPassword = document.getElementById('password-input').value;
            
            if (enteredPassword === currentEventPassword) {
                // Store password in session
                sessionStorage.setItem(`eventPassword_${currentEventId}`, enteredPassword);
                document.getElementById('password-modal').style.display = 'none';
                document.getElementById('password-input').value = '';
                initializeApp();
            } else {
                alert('Incorrect password');
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }
        
        function createNewEvent() {
            showCreateEventModal();
        }
        
        function showCreateEventModal() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('event-date-input').value = today;
            
            document.getElementById('create-event-modal').style.display = 'flex';
            document.getElementById('event-name-input').focus();
        }
        
        function closeCreateEventModal() {
            document.getElementById('create-event-modal').style.display = 'none';
            // Clear form
            document.getElementById('event-name-input').value = '';
            document.getElementById('event-date-input').value = '';
            document.getElementById('event-host-input').value = '';
            document.getElementById('event-address-input').value = '';
            document.getElementById('initial-guests-input').value = '';
            document.getElementById('initial-items-input').value = '';
            document.getElementById('event-password-input').value = '';
        }
        
        function generateEventId(eventName) {
            // Create URL-friendly slug from event name
            const slug = eventName.toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .substring(0, 30); // Limit length
            
            // Generate random 6-character code
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return `${slug}-${code}`;
        }
        
        function parseGuestList(guestsText) {
            if (!guestsText.trim()) return [];
            
            const guestEntries = guestsText.split(',').map(entry => entry.trim()).filter(entry => entry);
            const guests = [];
            
            guestEntries.forEach(entry => {
                const match = entry.match(/^(.+?)\s*-\s*(\d+)$/);
                if (match) {
                    guests.push({
                        name: match[1].trim(),
                        count: parseInt(match[2])
                    });
                } else {
                    guests.push({
                        name: entry.trim(),
                        count: 1
                    });
                }
            });
            
            return guests;
        }
        
        async function createEventFromModal() {
            const eventName = document.getElementById('event-name-input').value.trim();
            const eventDate = document.getElementById('event-date-input').value;
            const eventHost = document.getElementById('event-host-input').value.trim();
            const eventAddress = document.getElementById('event-address-input').value.trim();
            const guestsText = document.getElementById('initial-guests-input').value.trim();
            const itemsText = document.getElementById('initial-items-input').value.trim();
            const password = document.getElementById('event-password-input').value;
            
            if (!eventName || !eventDate) {
                alert('Please fill in the event name and date.');
                return;
            }
            
            try {
                const eventId = generateEventId(eventName);
                const guests = parseGuestList(guestsText);
                const items = itemsText ? itemsText.split(',').map(item => item.trim()).filter(item => item) : [];
                
                // Prepare guest data
                const guestList = guests.map(g => g.name);
                const rsvpData = {};
                guests.forEach(guest => {
                    rsvpData[guest.name] = {
                        status: 'pending',
                        guests: guest.count,
                        previousGuests: guest.count
                    };
                });
                
                // Prepare bring data
                const bringData = {};
                items.forEach(item => {
                    bringData[item] = { assigned: false, person: null };
                });
                
                const eventData = {
                    eventId,
                    eventName,
                    currentDate: eventDate,
                    currentHost: eventHost,
                    currentAddress: eventAddress,
                    guestList,
                    rsvpData,
                    bringItems: items,
                    bringData,
                    additionalGuests: [],
                    password: password || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('events').doc(eventId).set(eventData);
                
                // Redirect to the new event page
                window.location.href = `event.html?id=${eventId}`;
                
            } catch (error) {
                console.error('Error creating event:', error);
                alert('Failed to create event. Please try again.');
            }
        }
        
        // Initialize the app
        async function initializeApp() {
            // Check if we have access to this event
            const hasAccess = await checkEventAccess();
            if (!hasAccess) return;
            
            // Load state from Firebase
            await loadStateFromFirebase();
            
            // Set up real-time sync
            setupRealtimeSync();
            
            // Initialize and display
            initializeBringData();
            
            // For owners, always show full content immediately
            // For guests, handle based on whether they've visited before
            if (isEventOwner()) {
                // Owner always gets full interface
                updateDisplay();
            } else if (localStorage.getItem(`guest_name_${currentEventId}`)) {
                // Returning guest - show restricted view
                updateDisplay();
                setTimeout(() => {
                    showGuestNamePrompt();
                }, 100);
            } else {
                // New guest - hide content and show search modal
                hidePageContentForGuests();
                setTimeout(() => {
                    showGuestNamePrompt();
                }, 500);
            }
        }
        
        // Start the app
        window.addEventListener('load', () => {
            currentEventId = getEventIdFromUrl();
            
            if (!currentEventId) {
                window.location.href = 'index.html';
                return;
            }
            
            initializeApp();
        });
        
        // Guest Name Search and RSVP Functions
        let selectedGuestName = null;
        let selectedGuestType = null; // 'existing' or 'new'
        
        function showGuestNamePrompt() {
            // Don't show prompt for event owners
            if (isEventOwner()) {
                return;
            }
            
            // Check if guest name is already stored
            const storedName = localStorage.getItem(`guest_name_${currentEventId}`);
            if (storedName) {
                currentGuestName = storedName;
                // If they already have a stored name, show them the restricted view directly
                showGuestRestrictedView();
                return;
            }
            
            document.getElementById('guest-name-modal').style.display = 'flex';
            document.getElementById('guest-search-input').focus();
            searchGuests(); // Show initial results
        }
        
        function searchGuests() {
            const searchTerm = document.getElementById('guest-search-input').value.toLowerCase();
            const resultsContainer = document.getElementById('guest-search-results');
            
            // Get all guest names
            const allGuests = [
                ...guestList.map(name => ({ name, type: 'existing' })),
                ...additionalGuests.map(guest => ({ name: guest.name, type: 'additional' }))
            ];
            
            if (searchTerm.length === 0) {
                // Show all guests when no search term
                renderGuestSearchResults(allGuests);
                return;
            }
            
            // Filter and sort by relevance
            const filtered = allGuests.filter(guest => 
                guest.name.toLowerCase().includes(searchTerm)
            ).sort((a, b) => {
                // Exact matches first
                const aExact = a.name.toLowerCase() === searchTerm;
                const bExact = b.name.toLowerCase() === searchTerm;
                if (aExact !== bExact) return bExact - aExact;
                
                // Then by how early the match appears
                const aIndex = a.name.toLowerCase().indexOf(searchTerm);
                const bIndex = b.name.toLowerCase().indexOf(searchTerm);
                return aIndex - bIndex;
            });
            
            renderGuestSearchResults(filtered);
        }
        
        function renderGuestSearchResults(guests) {
            const container = document.getElementById('guest-search-results');
            
            if (guests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No matching names found</p>';
                return;
            }
            
            container.innerHTML = guests.map(guest => `
                <button class="person-btn" onclick="selectGuest('${guest.name.replace(/'/g, "\\'")}', '${guest.type}')" 
                        style="display: block; width: 100%; text-align: left; margin: 3px 0;">
                    ${guest.name}
                </button>
            `).join('');
        }
        
        function selectFirstMatch() {
            const firstButton = document.querySelector('#guest-search-results .person-btn');
            if (firstButton) {
                firstButton.click();
            }
        }
        
        function selectGuest(guestName, guestType) {
            selectedGuestName = guestName;
            selectedGuestType = guestType;
            
            // Close search modal
            document.getElementById('guest-name-modal').style.display = 'none';
            
            // Show RSVP modal
            document.getElementById('rsvp-guest-name').textContent = `Hello, ${guestName}!`;
            document.getElementById('guest-rsvp-modal').style.display = 'flex';
        }
        
        function addNewGuest() {
            const searchInput = document.getElementById('guest-search-input');
            const name = searchInput.value.trim();
            
            if (!name) {
                alert('Please enter your name first.');
                return;
            }
            
            selectedGuestName = name;
            selectedGuestType = 'new';
            
            // Close search modal
            document.getElementById('guest-name-modal').style.display = 'none';
            
            // Show RSVP modal
            document.getElementById('rsvp-guest-name').textContent = `Hello, ${name}!`;
            document.getElementById('guest-rsvp-modal').style.display = 'flex';
        }
        
        function submitGuestRSVP(status) {
            if (!selectedGuestName) return;
            
            currentGuestName = selectedGuestName;
            localStorage.setItem(`guest_name_${currentEventId}`, selectedGuestName);
            
            const guestCount = status === 'coming' ? 
                parseInt(document.getElementById('guest-count-input').value) || 1 : 0;
            
            if (selectedGuestType === 'existing') {
                // Update existing guest in main list
                if (!rsvpData[selectedGuestName]) {
                    rsvpData[selectedGuestName] = { status: 'pending', guests: 1, previousGuests: 1 };
                }
                rsvpData[selectedGuestName].status = status;
                rsvpData[selectedGuestName].guests = guestCount;
                if (status === 'coming') {
                    rsvpData[selectedGuestName].previousGuests = guestCount;
                }
            } else if (selectedGuestType === 'additional') {
                // Update existing additional guest
                const additionalGuest = additionalGuests.find(g => g.name === selectedGuestName);
                if (additionalGuest) {
                    additionalGuest.status = status;
                    additionalGuest.guests = guestCount;
                    if (status === 'coming') {
                        additionalGuest.previousGuests = guestCount;
                    }
                }
            } else {
                // Add new guest
                additionalGuests.push({
                    name: selectedGuestName,
                    status: status,
                    guests: guestCount,
                    previousGuests: guestCount
                });
            }
            
            // Close RSVP modal
            document.getElementById('guest-rsvp-modal').style.display = 'none';
            
            // Save and show restricted view
            saveStateToFirebase();
            showGuestRestrictedView();
        }
        
        function showGuestRestrictedView() {
            // Don't apply guest restrictions to owners
            if (isEventOwner()) {
                return;
            }
            
            // Show the page content now that guest has RSVP'd
            showPageContentForGuests();
            
            // Hide elements that guests shouldn't see
            hideElementsForGuests();
            
            // Update display with guest restrictions
            updateDisplay();
            
            // Show thank you message
            showGuestWelcomeMessage();
        }
        
        function hideElementsForGuests() {
            // Hide owner controls
            const ownerControls = document.getElementById('owner-controls');
            if (ownerControls) ownerControls.style.display = 'none';
            
            // Hide new event button
            const newEventBtn = document.getElementById('new-event-btn');
            if (newEventBtn) newEventBtn.style.display = 'none';
            
            // Hide user profile section
            const userProfileSection = document.getElementById('user-profile-section');
            if (userProfileSection) userProfileSection.style.display = 'none';
        }
        
        function hidePageContentForGuests() {
            // Hide the main container initially for new guests
            const container = document.querySelector('.container');
            if (container) {
                container.style.display = 'none';
            }
            hideElementsForGuests();
        }
        
        function showPageContentForGuests() {
            // Show the main container after RSVP
            const container = document.querySelector('.container');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        function showGuestWelcomeMessage() {
            // Show a brief welcome message
            const container = document.querySelector('.container');
            if (container) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.style.cssText = 'background: #e6fffa; border: 1px solid #81e6d9; border-radius: 8px; padding: 15px; margin: 20px; text-align: center; color: #234e52;';
                welcomeMsg.innerHTML = `<strong>Welcome, ${currentGuestName}!</strong><br>Thanks for your RSVP. Here's what you can see for this event:`;
                container.insertBefore(welcomeMsg, container.firstChild);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    if (welcomeMsg.parentNode) {
                        welcomeMsg.parentNode.removeChild(welcomeMsg);
                    }
                }, 5000);
            }
        }
        
        // Close modals when clicking outside
        document.getElementById('selection-modal').onclick = function(e) {
            if (e.target === this) closeModal();
        }
        
        document.getElementById('edit-modal').onclick = function(e) {
            if (e.target === this) closeEditModal();
        }
        
        
        document.getElementById('date-modal').onclick = function(e) {
            if (e.target === this) closeDateModal();
        }
        
        document.getElementById('guests-modal').onclick = function(e) {
            if (e.target === this) closeGuestsModal();
        }
        
        // Guest modal event handlers
        document.getElementById('guest-rsvp-modal').onclick = function(e) {
            if (e.target === this) {
                // Don't allow closing by clicking outside - guests must make a choice
            }
        }
        
        // Show guest count input when "Yes" is clicked
        function showGuestCountForRSVP() {
            document.getElementById('guest-count-section').style.display = 'block';
        }
        
        // Note: Guest name modal doesn't allow closing by clicking outside - guests must select or add their name
        
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const indicator = document.getElementById(sectionId.replace('-section', '-indicator'));
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                section.style.maxHeight = section.scrollHeight + 'px';
                indicator.classList.remove('collapsed');
            } else {
                section.style.maxHeight = section.scrollHeight + 'px';
                setTimeout(() => {
                    section.classList.add('collapsed');
                    indicator.classList.add('collapsed');
                }, 10);
            }
        }
        
        function initializeSectionHeights() {
            const sections = document.querySelectorAll('.section-content');
            sections.forEach(section => {
                if (!section.classList.contains('collapsed')) {
                    section.style.maxHeight = section.scrollHeight + 'px';
                }
            });
        }
        
        // Authentication and permission functions
        function updateOwnershipUI() {
            const ownerControls = document.getElementById('owner-controls');
            const isOwner = currentUser && eventOwner && currentUser.uid === eventOwner;
            
            if (isOwner) {
                ownerControls.style.display = 'flex';
            } else {
                ownerControls.style.display = 'none';
            }
        }
        
        function updatePermissionBasedUI() {
            const isOwner = isEventOwner();
            const isGuest = !isOwner && currentGuestName;
            const guestSection = document.querySelector('.section:has(#rsvp-list)');
            const bringSection = document.querySelector('.section:has(#bring-list)');
            
            // For guests who have completed RSVP, apply strict permissions
            if (isGuest) {
                // Hide guest list if not allowed to view
                if (!eventPermissions.allowGuestView) {
                    if (guestSection) {
                        guestSection.style.display = 'none';
                    }
                } else {
                    // Show guest list but with restrictions applied in updateRSVPList
                    if (guestSection) {
                        guestSection.style.display = 'block';
                    }
                }
                
                // Hide items list if not allowed to view
                if (!eventPermissions.allowItemView) {
                    if (bringSection) {
                        bringSection.style.display = 'none';
                    }
                } else {
                    if (bringSection) {
                        bringSection.style.display = 'block';
                    }
                }
                
                // Always hide editing controls for guests
                hideGuestEditingControls();
            } else {
                // For owners, show everything
                if (guestSection) guestSection.style.display = 'block';
                if (bringSection) bringSection.style.display = 'block';
            }
            
            // Add permission notices
            addPermissionNotices();
            
            // Update edit capabilities
            updateEditCapabilities();
        }
        
        function hideGuestEditingControls() {
            // Only hide controls if user is actually a guest (not owner)
            if (isEventOwner()) return;
            
            // Hide edit buttons in section headers for guests
            document.querySelectorAll('.edit-btn').forEach(btn => {
                if (!eventPermissions.allowItemEdits && btn.textContent.includes('Edit Items')) {
                    btn.style.display = 'none';
                }
            });
            
            // Hide guest remove buttons and edit capabilities for guests
            if (!eventPermissions.allowGuestEdits) {
                document.querySelectorAll('[onclick*="removeGuest"]').forEach(btn => {
                    btn.style.display = 'none';
                });
                document.querySelectorAll('[onclick*="editGuestName"]').forEach(span => {
                    span.style.cursor = 'default';
                    span.style.textDecoration = 'none';
                    span.onclick = null;
                });
            }
        }
        
        function addPermissionNotices() {
            // Remove existing notices
            document.querySelectorAll('.permission-notice').forEach(notice => notice.remove());
            
            const isOwner = isEventOwner();
            
            // Guest editing notice
            if (!eventPermissions.allowGuestEdits && !isOwner && eventPermissions.allowGuestView) {
                const guestSection = document.getElementById('guests-section');
                if (guestSection) {
                    const notice = document.createElement('div');
                    notice.className = 'permission-notice';
                    notice.innerHTML = '<strong>Note:</strong> You can RSVP and change your guest count, but cannot edit names.';
                    guestSection.insertBefore(notice, guestSection.firstChild);
                }
            }
            
            // Item editing notice
            if (!eventPermissions.allowItemEdits && !isOwner && eventPermissions.allowItemView) {
                const bringSection = document.getElementById('bring-section');
                if (bringSection) {
                    const notice = document.createElement('div');
                    notice.className = 'permission-notice';
                    notice.innerHTML = '<strong>Note:</strong> You can claim items but cannot add or edit the list.';
                    bringSection.insertBefore(notice, bringSection.firstChild);
                }
            }
        }
        
        function updateEditCapabilities() {
            const isOwner = isEventOwner();
            
            // Update guest name edit buttons
            document.querySelectorAll('.family-member span').forEach(span => {
                if (!isOwner && !eventPermissions.allowGuestEdits) {
                    span.style.cursor = 'default';
                    span.style.textDecoration = 'none';
                    span.onclick = null;
                } else {
                    span.style.cursor = 'pointer';
                    span.style.textDecoration = 'underline';
                    span.style.textDecorationStyle = 'dotted';
                }
            });
            
            // Update item edit buttons
            const editItemsBtn = document.querySelector('.section-header .edit-btn');
            if (editItemsBtn) {
                if (!isOwner && !eventPermissions.allowItemEdits) {
                    editItemsBtn.style.display = 'none';
                } else {
                    editItemsBtn.style.display = 'inline-block';
                }
            }
            
            // Update add guests button
            const addGuestsBtn = document.querySelector('button[onclick*="showAddGuestsModal"]');
            if (addGuestsBtn && !isOwner && !eventPermissions.allowGuestEdits) {
                addGuestsBtn.style.display = 'none';
            }
        }
        
        function isEventOwner() {
            return currentUser && eventOwner && currentUser.uid === eventOwner;
        }
        
        function canEditGuests() {
            return isEventOwner() || eventPermissions.allowGuestEdits;
        }
        
        function canEditItems() {
            return isEventOwner() || eventPermissions.allowItemEdits;
        }
        
        function canViewGuests() {
            return isEventOwner() || eventPermissions.allowGuestView;
        }
        
        function canViewItems() {
            return isEventOwner() || eventPermissions.allowItemView;
        }
        
        function showEventSettings() {
            if (!isEventOwner()) {
                alert('Only the event owner can change settings.');
                return;
            }
            
            // Load current settings into form
            document.getElementById('allow-guest-view').checked = eventPermissions.allowGuestView;
            document.getElementById('allow-guest-edits').checked = eventPermissions.allowGuestEdits;
            document.getElementById('allow-item-view').checked = eventPermissions.allowItemView;
            document.getElementById('allow-item-edits').checked = eventPermissions.allowItemEdits;
            document.getElementById('settings-password').value = currentEventPassword || '';
            
            document.getElementById('settings-modal').style.display = 'flex';
        }
        
        function closeEventSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }
        
        async function saveEventSettings() {
            if (!isEventOwner()) {
                alert('Only the event owner can change settings.');
                return;
            }
            
            const newPermissions = {
                allowGuestView: document.getElementById('allow-guest-view').checked,
                allowGuestEdits: document.getElementById('allow-guest-edits').checked,
                allowItemView: document.getElementById('allow-item-view').checked,
                allowItemEdits: document.getElementById('allow-item-edits').checked
            };
            
            const newPassword = document.getElementById('settings-password').value;
            
            try {
                await db.collection('events').doc(currentEventId).update({
                    permissions: newPermissions,
                    password: newPassword || null,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local state
                eventPermissions = newPermissions;
                currentEventPassword = newPassword || null;
                
                updatePermissionBasedUI();
                closeEventSettings();
                
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings. Please try again.');
            }
        }
        
        // Event page user profile functions
        function updateEventPageAuthUI(user) {
            const userProfileSection = document.getElementById('user-profile-section');
            const newEventBtn = document.getElementById('new-event-btn');
            
            if (user) {
                currentUser = user;
                userProfileSection.style.display = 'block';
                newEventBtn.style.display = 'none';
                
                // Update user info
                document.getElementById('event-user-email').textContent = user.email;
                document.getElementById('event-user-initial').textContent = user.email.charAt(0).toUpperCase();
            } else {
                currentUser = null;
                userProfileSection.style.display = 'none';
                newEventBtn.style.display = 'block';
            }
        }
        
        function toggleEventUserMenu() {
            const menu = document.getElementById('event-dropdown-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        async function showUserDashboard() {
            document.getElementById('event-dropdown-menu').style.display = 'none';
            loadUserDashboard();
            document.getElementById('dashboard-modal').style.display = 'flex';
        }
        
        async function signOut() {
            try {
                await auth.signOut();
                document.getElementById('event-dropdown-menu').style.display = 'none';
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }
        
        async function loadUserDashboard() {
            if (!currentUser) return;
            
            try {
                // First, ensure user document exists
                await db.collection('users').doc(currentUser.uid).set({
                    email: currentUser.email,
                    displayName: currentUser.displayName || currentUser.email.split('@')[0],
                    eventCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Then load events
                const eventsSnapshot = await db.collection('events')
                    .where('ownerId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const events = eventsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                updateDashboardStats(events);
                renderEventsList(events);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // If it's an index error, show a helpful message
                if (error.message.includes('index')) {
                    document.getElementById('user-events-list').innerHTML = '<p>Setting up your dashboard... Please wait a moment and try again.</p>';
                } else {
                    document.getElementById('user-events-list').innerHTML = '<p>No events created yet. <a href="#" onclick="window.location.href=\'index.html\';">Create your first event</a></p>';
                }
            }
        }
        
        function updateDashboardStats(events) {
            const totalEvents = events.length;
            const activeEvents = events.filter(event => {
                if (!event.currentDate) return false;
                const eventDate = new Date(event.currentDate);
                const today = new Date();
                return eventDate >= today;
            }).length;
            
            document.getElementById('total-events').textContent = totalEvents;
            document.getElementById('active-events').textContent = activeEvents;
        }
        
        function renderEventsList(events) {
            const container = document.getElementById('user-events-list');
            
            if (events.length === 0) {
                container.innerHTML = '<p>No events created yet. <a href="#" onclick="window.location.href=\'index.html\';">Create your first event</a></p>';
                return;
            }
            
            const eventsHTML = events.map(event => {
                const eventDate = event.currentDate ? new Date(event.currentDate).toLocaleDateString() : 'No date set';
                const guestCount = event.guestList ? event.guestList.length : 0;
                const itemCount = event.bringItems ? event.bringItems.length : 0;
                
                return `
                    <div class="event-card">
                        <div class="event-card-header">
                            <div class="event-title">${event.eventName || event.currentEventName || 'Untitled Event'}</div>
                            <div class="event-date">${eventDate}</div>
                        </div>
                        <div class="event-stats">
                            <span>👥 ${guestCount} guests</span>
                            <span>🍽️ ${itemCount} items</span>
                        </div>
                        <div class="event-actions">
                            <button class="event-btn" onclick="openEvent('${event.id}')">Open Event</button>
                            <button class="event-btn" onclick="copyEventLink('${event.id}')">Copy Link</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = eventsHTML;
        }
        
        function openEvent(eventId) {
            window.location.href = `event.html?id=${eventId}`;
        }
        
        function copyEventLink(eventId) {
            const link = `${window.location.origin}/event.html?id=${eventId}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('Event link copied to clipboard!');
            });
        }
        
        function closeDashboardModal() {
            document.getElementById('dashboard-modal').style.display = 'none';
        }
        
        // Auth state listener
        auth.onAuthStateChanged((user) => {
            updateEventPageAuthUI(user);
            updateOwnershipUI();
            updatePermissionBasedUI();
        });
        
        document.getElementById('create-event-modal').onclick = function(e) {
            if (e.target === this) closeCreateEventModal();
        }
        
        document.getElementById('settings-modal').onclick = function(e) {
            if (e.target === this) closeEventSettings();
        }
        
        document.getElementById('dashboard-modal').onclick = function(e) {
            if (e.target === this) closeDashboardModal();
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('event-dropdown-menu');
            const avatar = document.getElementById('event-user-avatar');
            if (dropdown && avatar && !avatar.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    </script>
</body>
</html>
